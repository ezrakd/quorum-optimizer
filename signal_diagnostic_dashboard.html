<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quorum Optimizer — Signal Coverage Diagnostic</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1" integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ" crossorigin="anonymous"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f1117;color:#e0e0e0;line-height:1.5}
.dashboard{max-width:1440px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:12px}
header h1{font-size:22px;font-weight:600;color:#fff}
header .subtitle{font-size:13px;color:#888;margin-top:4px}
.timestamp{font-size:11px;color:#666;margin-top:6px}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.kpi{background:#1a1d27;border-radius:10px;padding:16px 20px;border:1px solid #2a2d3a}
.kpi .label{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:.5px}
.kpi .value{font-size:28px;font-weight:700;margin:4px 0;color:#fff}
.kpi .sub{font-size:12px;color:#666}
.kpi.green .value{color:#4ade80}
.kpi.amber .value{color:#fbbf24}
.kpi.red .value{color:#f87171}
.kpi.blue .value{color:#60a5fa}
.section{background:#1a1d27;border-radius:10px;padding:20px;border:1px solid #2a2d3a;margin-bottom:20px}
.section h2{font-size:15px;font-weight:600;color:#fff;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.section h2 .badge{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:500}
.badge-green{background:#166534;color:#4ade80}
.badge-amber{background:#713f12;color:#fbbf24}
.badge-red{background:#7f1d1d;color:#f87171}
table{width:100%;border-collapse:collapse;font-size:12px}
th{text-align:left;padding:8px 10px;border-bottom:2px solid #2a2d3a;color:#888;font-weight:600;text-transform:uppercase;font-size:10px;letter-spacing:.5px;white-space:nowrap}
th.right,td.right{text-align:right}
td{padding:7px 10px;border-bottom:1px solid #1f2230}
tr:hover td{background:#1f2230}
.signal{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:2px}
.signal.on{background:#4ade80}
.signal.off{background:#f87171}
.signal.partial{background:#fbbf24}
.chip{display:inline-block;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600}
.chip-green{background:#166534;color:#4ade80}
.chip-red{background:#7f1d1d;color:#f87171}
.chip-amber{background:#713f12;color:#fbbf24}
.chip-blue{background:#1e3a5f;color:#60a5fa}
.chip-gray{background:#2a2d3a;color:#888}
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
.chart-box{background:#1a1d27;border-radius:10px;padding:20px;border:1px solid #2a2d3a}
.chart-box h3{font-size:13px;color:#ccc;margin-bottom:12px}
canvas{max-height:280px}
.finding{padding:12px 16px;border-radius:8px;margin-bottom:10px;font-size:13px;line-height:1.6}
.finding.critical{background:#2d1215;border-left:3px solid #f87171;color:#fca5a5}
.finding.warning{background:#2d2410;border-left:3px solid #fbbf24;color:#fde68a}
.finding.success{background:#0d2818;border-left:3px solid #4ade80;color:#86efac}
.finding.info{background:#0f1d33;border-left:3px solid #60a5fa;color:#93c5fd}
.finding strong{color:#fff}
.arch-diagram{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:16px 0;font-size:11px;text-align:center}
.arch-box{padding:10px 6px;border-radius:6px;border:1px solid #2a2d3a}
.arch-box.source{background:#1e3a5f}
.arch-box.transform{background:#2d2410}
.arch-box.output{background:#0d2818}
.arch-arrow{display:flex;align-items:center;justify-content:center;color:#666;font-size:16px}
.legend{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0;font-size:11px;color:#888}
.legend-item{display:flex;align-items:center;gap:4px}
@media(max-width:900px){.charts-row{grid-template-columns:1fr}.arch-diagram{grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>
<div class="dashboard">

<header>
<div>
<h1>Quorum Optimizer — Signal Coverage Diagnostic</h1>
<div class="subtitle">Lift Analysis Readiness Audit · 20 Active Agencies · 60-Day Lookback</div>
<div class="timestamp">Generated: Feb 19, 2026 · Data window: Jan 15 – Feb 14, 2026</div>
</div>
</header>

<!-- KPI CARDS -->
<div class="kpis">
<div class="kpi green"><div class="label">Agencies with Impressions</div><div class="value">17/20</div><div class="sub">85% have impression log data via PCM</div></div>
<div class="kpi amber"><div class="label">Agencies with Web Visits</div><div class="value">6/20</div><div class="sub">30% have AD_TO_WEB_VISIT_ATTRIBUTION</div></div>
<div class="kpi green"><div class="label">Agencies with Store Visits</div><div class="value">15/20</div><div class="sub">75% — after UNION of both sources</div></div>
<div class="kpi red"><div class="label">Device-Level Lift Match Rate</div><div class="value">~0%</div><div class="sub">MAID ≠ DEVICE_ID_RAW for 99%+ of rows</div></div>
</div>

<!-- CRITICAL FINDINGS -->
<div class="section">
<h2>Key Findings <span class="badge badge-red">Action Required</span></h2>

<div class="finding critical">
<strong>MAID Identity Mismatch — Lift analysis device matching is broken for all agencies.</strong><br>
Attribution tables use synthetic MAIDs (MAID_SOURCE = IP_ENRICHED, 99.5%+), while the impression log has real device UUIDs (DEVICE_ID_RAW). These are fundamentally different ID spaces and will <em>never</em> match. Tested across Paramount (40514), Causal iQ (7391), and LotLinx (24658) — all show <strong>0 device overlap</strong> between exposed group and visitor group. The lift analysis currently uses <code>LEFT JOIN adv_web_visit_days wv ON wv.device_id = e.device_id</code> which joins these incompatible IDs.
</div>

<div class="finding warning">
<strong>Web visit attribution covers only 6 of 20 agencies.</strong><br>
AD_TO_WEB_VISIT_ATTRIBUTION has data for agencies: 1480, 2298, 1956, 2086, 1955, 1950. The other 14 agencies (including Causal iQ 1813, with 81M impressions) have zero web visit attribution rows. These agencies show 0 web visits and 0 web VR across all tabs.
</div>

<div class="finding success">
<strong>Store visit fix working — now covers 15 of 20 agencies.</strong><br>
After the UNION fix (commit aec8ebf), store visits are read from both WEB_TO_STORE_VISIT_ATTRIBUTION (7 agencies) and STORE_VISITS base table (11 agencies). Causal iQ went from 0 to 1.3M store visit rows. Only 5 agencies remain without any store visit data: 1221, 1448, 1697, 1955, 1950 — but 1955 and 1950 DO have store visits in the derived table (just not in the base table).
</div>

<div class="finding info">
<strong>Household resolution provides the bridge — but at 8-17% rate.</strong><br>
IP_HOUSEHOLD_LOOKUP has 68.6M IPs → 31.1M households. Tested resolution rates: Paramount 16.9%, Causal iQ 8.6%, LotLinx 8.9%. This is the only viable path for lift analysis: resolve both exposed IPs and attribution IPs to households, then measure overlap at the household level.
</div>
</div>

<!-- SIGNAL COVERAGE MATRIX -->
<div class="section">
<h2>Agency Signal Coverage Matrix</h2>
<div class="legend">
<div class="legend-item"><span class="signal on"></span> Data present</div>
<div class="legend-item"><span class="signal partial"></span> Partial/low coverage</div>
<div class="legend-item"><span class="signal off"></span> No data</div>
</div>
<table>
<thead>
<tr>
<th>Agency</th>
<th>Strategy</th>
<th>PT</th>
<th>Advs</th>
<th class="right">Impressions (10% sample)</th>
<th class="right">Devices</th>
<th>Imps</th>
<th>Web Attr</th>
<th>Store (Derived)</th>
<th>Store (Base)</th>
<th>Store Combined</th>
<th class="right">Signals</th>
</tr>
</thead>
<tbody id="agencyTable"></tbody>
</table>
</div>

<!-- ADVERTISER-LEVEL LIFT INGREDIENTS -->
<div class="section">
<h2>Advertiser-Level Lift Ingredient Audit <span class="badge badge-amber">Sampled</span></h2>
<p style="font-size:12px;color:#888;margin-bottom:12px">Top advertiser per agency · 1-5% impression sample · Jan 15 – Feb 14, 2026</p>
<table>
<thead>
<tr>
<th>Agency</th>
<th>Advertiser</th>
<th class="right">Exposed Devices</th>
<th class="right">HH Resolved</th>
<th class="right">HH Rate</th>
<th class="right">Web Visitor MAIDs</th>
<th class="right">Store Visitor MAIDs</th>
<th class="right">Device→Web Overlap</th>
<th class="right">Device→Store Overlap</th>
<th>MAID Source</th>
</tr>
</thead>
<tbody id="liftTable"></tbody>
</table>
</div>

<!-- CHARTS -->
<div class="charts-row">
<div class="chart-box">
<h3>Signal Coverage by Agency (sorted by impression volume)</h3>
<canvas id="signalChart"></canvas>
</div>
<div class="chart-box">
<h3>Identity Resolution Gap — Why Lift Matching Fails</h3>
<canvas id="identityChart"></canvas>
</div>
</div>

<div class="charts-row">
<div class="chart-box">
<h3>Store Visit Source Distribution</h3>
<canvas id="storeChart"></canvas>
</div>
<div class="chart-box">
<h3>MAID Source Breakdown (Web Attribution)</h3>
<canvas id="maidChart"></canvas>
</div>
</div>

<!-- ARCHITECTURE & MAINTENANCE PLAN -->
<div class="section">
<h2>System Architecture — Current State</h2>
<div class="arch-diagram">
<div class="arch-box source"><strong>AD_IMPRESSION_LOG_V2</strong><br>DEVICE_ID_RAW (real UUID)<br>USER_IP_FROM_HTTP_REQUEST<br>INSERTION_ORDER_ID</div>
<div class="arch-arrow">→</div>
<div class="arch-box transform"><strong>IP_HOUSEHOLD_LOOKUP</strong><br>IP_ADDRESS → HOUSEHOLD_ID<br>68.6M IPs → 31.1M HH<br>8-17% resolution rate</div>
<div class="arch-arrow">→</div>
<div class="arch-box output"><strong>HOUSEHOLD MATCH</strong><br>Exposed HH ∩ Visitor HH<br>Campaign-level via IO_ID<br>✅ Working for web visits</div>
</div>
<div class="arch-diagram" style="margin-top:4px">
<div class="arch-box source"><strong>AD_TO_WEB_VISIT_ATTRIBUTION</strong><br>MAID (99% synthetic)<br>HOUSEHOLD_ID (backfilled)<br>6 agencies only</div>
<div class="arch-arrow">→</div>
<div class="arch-box transform"><strong>PIXEL_CAMPAIGN_MAPPING_V2</strong><br>QUORUM_ADV → DSP_ADV<br>Bridges advertiser IDs<br>All 20 agencies mapped</div>
<div class="arch-arrow">→</div>
<div class="arch-box output"><strong>STORE_VISITS (base)</strong><br>+ WEB_TO_STORE_VISIT_ATTR<br>UNION of both sources<br>✅ 15/20 agencies covered</div>
</div>
</div>

<!-- RECOMMENDATIONS -->
<div class="section">
<h2>Recommended Actions</h2>

<div class="finding critical">
<strong>P0 — Rewrite lift analysis to use household-level matching.</strong><br>
Replace device-level JOIN (<code>exposed_devices LEFT JOIN adv_web_visit_days ON device_id</code>) with household-level matching: resolve exposed IPs → households via IP_HOUSEHOLD_LOOKUP, then match against attribution HOUSEHOLD_ID. This is the same approach that fixed campaign-level web visits (commit 0cda153). Without this, lift analysis returns near-zero visitors for the exposed group, making all lift calculations meaningless.
</div>

<div class="finding warning">
<strong>P1 — Investigate web visit attribution gap for 14 agencies.</strong><br>
AD_TO_WEB_VISIT_ATTRIBUTION only covers 6 agencies. The other 14 have zero web visit data. Possible causes: no web pixel deployed, pixel not matched to these agencies, or BUILD process not running for them. This needs investigation with the data engineering team (Ali).
</div>

<div class="finding warning">
<strong>P1 — Centralize store visit source selection in config.</strong><br>
Currently the app UNIONs both store visit tables blindly. Add a config field (e.g., STORE_VISIT_SOURCE = 'DERIVED' | 'BASE' | 'BOTH') to REF_ADVERTISER_CONFIG so each agency/advertiser explicitly declares its source. This prevents double-counting if an agency later appears in both tables.
</div>

<div class="finding info">
<strong>P2 — Improve IP→HH resolution rate.</strong><br>
Current rate: 8-17%. This limits the effective exposed group size for lift analysis. Potential improvements: temporal IP→HH resolution (Aziz's assignment), supplementing with MAID→HH mapping for the rare real-MAID rows, or using third-party identity graph data.
</div>

<div class="finding info">
<strong>P2 — Add signal health monitoring.</strong><br>
Build a daily Snowflake task that checks each agency's signal coverage (impressions, web visits, store visits, HH resolution) and alerts when signals go dark. This diagnostic should run automatically, not manually.
</div>
</div>

</div>

<script>
// ===== EMBEDDED DATA =====

const agencies = [
    {id:2514, name:'Agency 2514', strategy:'PCM_4KEY', pt:'22', configAdvs:61, impAdvs:31, impDevices:1324643, totalImps:87473866, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:24737, signals:2},
    {id:1813, name:'Causal iQ', strategy:'PCM_4KEY', pt:'9,23', configAdvs:19, impAdvs:13, impDevices:6209686, totalImps:80984574, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:1297306, signals:2},
    {id:1480, name:'Paramount', strategy:'ADM_PREFIX', pt:'21', configAdvs:725, impAdvs:210, impDevices:1488072, totalImps:17099820, webAdvs:117, webHH:214457, svDerivedRows:5242362, svBaseRows:14608, signals:4},
    {id:2744, name:'Agency 2744', strategy:'PCM_4KEY', pt:'22', configAdvs:1, impAdvs:1, impDevices:219961, totalImps:8583826, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:1542, signals:2},
    {id:2393, name:'Agency 2393', strategy:'PCM_4KEY', pt:'27', configAdvs:4, impAdvs:4, impDevices:5359097, totalImps:8222547, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:641, signals:2},
    {id:1972, name:'Agency 1972', strategy:'PCM_4KEY', pt:'9,13', configAdvs:12, impAdvs:9, impDevices:169143, totalImps:5333880, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:10425, signals:2},
    {id:2379, name:'Agency 2379', strategy:'PCM_4KEY', pt:'6', configAdvs:3, impAdvs:3, impDevices:418850, totalImps:5056883, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:9172, signals:2},
    {id:2234, name:'Agency 2234', strategy:'PCM_4KEY', pt:'20', configAdvs:1, impAdvs:6, impDevices:4829718, totalImps:4845966, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:12728, signals:2},
    {id:1956, name:'Agency 1956', strategy:'ADM_PREFIX', pt:'13', configAdvs:72, impAdvs:67, impDevices:571314, totalImps:3495890, webAdvs:66, webHH:32129, svDerivedRows:59661001, svBaseRows:0, signals:4},
    {id:2298, name:'Agency 2298', strategy:'ADM_PREFIX', pt:'13', configAdvs:34, impAdvs:32, impDevices:137570, totalImps:862611, webAdvs:33, webHH:38184, svDerivedRows:66532969, svBaseRows:0, signals:4},
    {id:1950, name:'Agency 1950', strategy:'ADM_PREFIX', pt:'13', configAdvs:6, impAdvs:6, impDevices:23551, totalImps:659589, webAdvs:6, webHH:2797, svDerivedRows:1586759, svBaseRows:0, signals:4},
    {id:1955, name:'Agency 1955', strategy:'ADM_PREFIX', pt:'13', configAdvs:9, impAdvs:9, impDevices:52783, totalImps:390043, webAdvs:8, webHH:7266, svDerivedRows:9089701, svBaseRows:0, signals:4},
    {id:2086, name:'Agency 2086', strategy:'ADM_PREFIX', pt:'13', configAdvs:10, impAdvs:4, impDevices:47912, totalImps:260530, webAdvs:9, webHH:22696, svDerivedRows:36399270, svBaseRows:0, signals:4},
    {id:1880, name:'Agency 1880', strategy:'PCM_4KEY', pt:'9', configAdvs:29, impAdvs:14, impDevices:38493, totalImps:66765, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:32775, signals:2},
    {id:1697, name:'Agency 1697', strategy:'PCM_4KEY', pt:'13', configAdvs:5, impAdvs:3, impDevices:5023, totalImps:10041, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:0, signals:1},
    {id:1565, name:'LotLinx 1565', strategy:'ADM_PREFIX', pt:'13', configAdvs:4, impAdvs:3, impDevices:2575, totalImps:2575, webAdvs:0, webHH:0, svDerivedRows:16592, svBaseRows:0, signals:2},
    {id:1445, name:'Publicis', strategy:'PCM_4KEY', pt:'13', configAdvs:1, impAdvs:1, impDevices:5, totalImps:332, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:2313, signals:2},
    {id:1221, name:'Spinoff', strategy:'PCM_4KEY', pt:'13', configAdvs:3, impAdvs:0, impDevices:0, totalImps:0, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:0, signals:0},
    {id:1448, name:'Quan Media', strategy:'PCM_4KEY', pt:'13', configAdvs:1, impAdvs:0, impDevices:0, totalImps:0, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:0, signals:0},
    {id:2691, name:'Agency 2691', strategy:'PCM_4KEY', pt:'9', configAdvs:1, impAdvs:0, impDevices:0, totalImps:0, webAdvs:0, webHH:0, svDerivedRows:0, svBaseRows:639, signals:1}
];

const liftAudit = [
    {agency:'Paramount', agencyId:1480, advId:40514, exposedDevices:22231, hhResolved:3758, hhRate:16.9, webMAIDs:552481, storeMAIDs:0, webOverlap:27, storeOverlap:0, maidSource:'99.8% IP_ENRICHED'},
    {agency:'Causal iQ', agencyId:1813, advId:7391, exposedDevices:20799, hhResolved:1795, hhRate:8.6, webMAIDs:0, storeMAIDs:59538, webOverlap:0, storeOverlap:0, maidSource:'100% V5 (real UUID)'},
    {agency:'Agency 2298', agencyId:2298, advId:24658, exposedDevices:7980, hhResolved:708, hhRate:8.9, webMAIDs:5348, storeMAIDs:584, webOverlap:0, storeOverlap:0, maidSource:'99.5% IP_ENRICHED'},
    {agency:'Agency 2514', agencyId:2514, advId:45718, exposedDevices:'~35.9M (5%)', hhResolved:'—', hhRate:'—', webMAIDs:0, storeMAIDs:103, webOverlap:0, storeOverlap:0, maidSource:'N/A (no web attr)'},
    {agency:'Agency 1972', agencyId:1972, advId:25523, exposedDevices:'~1.3M (5%)', hhResolved:'—', hhRate:'—', webMAIDs:0, storeMAIDs:1084, webOverlap:0, storeOverlap:0, maidSource:'BASE only'},
    {agency:'Agency 1880', agencyId:1880, advId:37936, exposedDevices:'~9.8K (5%)', hhResolved:'—', hhRate:'—', webMAIDs:0, storeMAIDs:0, webOverlap:0, storeOverlap:0, maidSource:'N/A'}
];

// ===== RENDER FUNCTIONS =====

function fmt(n) {
    if (typeof n === 'string') return n;
    if (n === 0) return '—';
    if (n >= 1e9) return (n/1e9).toFixed(1) + 'B';
    if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(1) + 'K';
    return n.toLocaleString();
}

function signalDot(val) {
    if (val > 0) return '<span class="signal on"></span>';
    return '<span class="signal off"></span>';
}

function chip(text, type) {
    return `<span class="chip chip-${type}">${text}</span>`;
}

// Agency table
const tbody = document.getElementById('agencyTable');
agencies.forEach(a => {
    const hasImps = a.totalImps > 0;
    const hasWeb = a.webAdvs > 0;
    const hasSvD = a.svDerivedRows > 0;
    const hasSvB = a.svBaseRows > 0;
    const hasStore = hasSvD || hasSvB;
    const sigCount = (hasImps?1:0) + 1 + (hasWeb?1:0) + (hasStore?1:0); // PCM always 1

    const sigChip = sigCount >= 4 ? chip(sigCount+'/4','green') :
                    sigCount >= 2 ? chip(sigCount+'/4','amber') :
                    chip(sigCount+'/4','red');

    tbody.innerHTML += `<tr>
        <td><strong>${a.id}</strong> <span style="color:#888;font-size:11px">${a.name}</span></td>
        <td>${a.strategy === 'ADM_PREFIX' ? chip('ADM','blue') : chip('PCM','gray')}</td>
        <td style="color:#888">${a.pt}</td>
        <td class="right">${a.configAdvs}</td>
        <td class="right">${fmt(a.totalImps)}</td>
        <td class="right">${fmt(a.impDevices)}</td>
        <td>${signalDot(a.totalImps)}</td>
        <td>${hasWeb ? signalDot(1) + ' ' + fmt(a.webHH) + ' HH' : signalDot(0)}</td>
        <td>${hasSvD ? signalDot(1) + ' ' + fmt(a.svDerivedRows) : signalDot(0)}</td>
        <td>${hasSvB ? signalDot(1) + ' ' + fmt(a.svBaseRows) : signalDot(0)}</td>
        <td>${hasStore ? signalDot(1) : signalDot(0)}</td>
        <td class="right">${sigChip}</td>
    </tr>`;
});

// Lift audit table
const liftTbody = document.getElementById('liftTable');
liftAudit.forEach(l => {
    const hhChip = typeof l.hhRate === 'number' ?
        (l.hhRate >= 15 ? chip(l.hhRate+'%','green') : l.hhRate >= 5 ? chip(l.hhRate+'%','amber') : chip(l.hhRate+'%','red')) :
        chip('—','gray');
    const overlapChip = (l.webOverlap === 0 && l.storeOverlap === 0) ? chip('ZERO','red') : chip(l.webOverlap + '/' + l.storeOverlap,'amber');

    liftTbody.innerHTML += `<tr>
        <td><strong>${l.agencyId}</strong> <span style="color:#888">${l.agency}</span></td>
        <td>${l.advId}</td>
        <td class="right">${fmt(l.exposedDevices)}</td>
        <td class="right">${fmt(l.hhResolved)}</td>
        <td class="right">${hhChip}</td>
        <td class="right">${fmt(l.webMAIDs)}</td>
        <td class="right">${fmt(l.storeMAIDs)}</td>
        <td class="right">${overlapChip}</td>
        <td class="right">${overlapChip}</td>
        <td style="font-size:10px;color:#888">${l.maidSource}</td>
    </tr>`;
});

// ===== CHARTS =====
Chart.defaults.color = '#888';
Chart.defaults.borderColor = '#2a2d3a';

// Signal coverage chart
const sigLabels = agencies.slice(0,17).map(a => a.id);
new Chart(document.getElementById('signalChart'), {
    type: 'bar',
    data: {
        labels: sigLabels,
        datasets: [
            {label:'Impressions', data: agencies.slice(0,17).map(a => a.totalImps > 0 ? 1 : 0), backgroundColor:'#60a5fa'},
            {label:'Web Visits', data: agencies.slice(0,17).map(a => a.webAdvs > 0 ? 1 : 0), backgroundColor:'#4ade80'},
            {label:'Store Visits', data: agencies.slice(0,17).map(a => (a.svDerivedRows + a.svBaseRows) > 0 ? 1 : 0), backgroundColor:'#fbbf24'}
        ]
    },
    options: {
        responsive: true,
        plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
        scales:{
            x:{stacked:true, ticks:{font:{size:10}}},
            y:{stacked:true, max:3, ticks:{stepSize:1, callback:v=>['','Imps','Web','Store'][v]}, title:{display:true,text:'Signals Present'}}
        }
    }
});

// Identity resolution gap chart
new Chart(document.getElementById('identityChart'), {
    type: 'bar',
    data: {
        labels: ['Paramount\n40514', 'Causal iQ\n7391', 'Agency 2298\n24658'],
        datasets: [
            {label:'Exposed Devices', data:[22231, 20799, 7980], backgroundColor:'#60a5fa'},
            {label:'HH Resolved', data:[3758, 1795, 708], backgroundColor:'#4ade80'},
            {label:'Device→Visitor Overlap', data:[27, 0, 0], backgroundColor:'#f87171'}
        ]
    },
    options: {
        responsive: true,
        plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
        scales:{
            x:{ticks:{font:{size:10}}},
            y:{type:'logarithmic', title:{display:true,text:'Count (log scale)'}}
        }
    }
});

// Store visit sources chart
const svAgencies = agencies.filter(a => a.svDerivedRows > 0 || a.svBaseRows > 0);
new Chart(document.getElementById('storeChart'), {
    type: 'bar',
    data: {
        labels: svAgencies.map(a => a.id),
        datasets: [
            {label:'Derived (web→store)', data: svAgencies.map(a => a.svDerivedRows), backgroundColor:'#818cf8'},
            {label:'Base (ad→store)', data: svAgencies.map(a => a.svBaseRows), backgroundColor:'#fb923c'}
        ]
    },
    options: {
        responsive: true,
        plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
        scales:{
            x:{stacked:true,ticks:{font:{size:10}}},
            y:{stacked:true,type:'logarithmic',title:{display:true,text:'Rows (log)'}}
        }
    }
});

// MAID source breakdown chart
new Chart(document.getElementById('maidChart'), {
    type: 'doughnut',
    data: {
        labels: ['IP_ENRICHED (synthetic)', 'HOUSEHOLD (real)', 'V5 / other (real UUID)'],
        datasets: [{
            data: [99.5, 0.3, 0.2],
            backgroundColor: ['#f87171', '#4ade80', '#60a5fa'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        plugins:{
            legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}},
            title:{display:true,text:'Web Attribution MAID Types (% of rows)',font:{size:12},color:'#ccc'}
        }
    }
});
</script>
</body>
</html>
