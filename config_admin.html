<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quorum ‚Äî Advertiser Hub</title>
    <link rel="icon" type="image/png" href="/quorum-favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1419; color: #e7e9ea; }
        ::selection { background: rgba(29,155,240,0.3); }

        /* Layout */
        .app { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-bar { background: #16202a; border-bottom: 1px solid #2f3942; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .top-bar-left { display: flex; align-items: center; gap: 14px; }
        .top-bar-title { font-size: 17px; font-weight: 700; }
        .top-bar-title span { color: #1d9bf0; }
        .back-link { color: #8b98a5; text-decoration: none; font-size: 12px; padding: 5px 10px; border: 1px solid #3d5466; border-radius: 5px; }
        .back-link:hover { color: #e7e9ea; border-color: #1d9bf0; }
        .top-bar-right { display: flex; align-items: center; gap: 10px; }
        .user-info { font-size: 11px; color: #8b98a5; }
        .user-info .role { color: #1d9bf0; text-transform: uppercase; font-weight: 600; font-size: 10px; }

        /* Main layout: sidebar + content */
        .main { display: flex; flex: 1; overflow: hidden; }

        /* Left sidebar: advertiser list */
        .sidebar { width: 380px; min-width: 380px; background: #16202a; border-right: 1px solid #2f3942; display: flex; flex-direction: column; overflow: hidden; transition: width 0.2s, min-width 0.2s; }
        .sidebar.collapsed { width: 0; min-width: 0; border-right: none; overflow: hidden; }
        .sidebar-header { padding: 12px 14px; border-bottom: 1px solid #2f3942; }
        .sidebar-header h3 { font-size: 13px; font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-filters { display: flex; gap: 6px; margin-bottom: 6px; }
        .search-wrap { position: relative; width: 100%; }
        .sidebar-search { width: 100%; padding: 7px 10px 7px 30px; background: #273340; border: 1px solid #3d5466; border-radius: 6px; color: #e7e9ea; font-size: 12px; }
        .sidebar-search:focus { outline: none; border-color: #1d9bf0; box-shadow: 0 0 0 2px rgba(29,155,240,0.15); }
        .search-icon { position: absolute; left: 9px; top: 50%; transform: translateY(-50%); color: #8b98a5; font-size: 13px; pointer-events: none; }
        .search-clear { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); color: #8b98a5; font-size: 14px; cursor: pointer; padding: 2px 4px; display: none; background: none; border: none; line-height: 1; }
        .search-clear:hover { color: #e7e9ea; }
        .search-wrap.has-value .search-clear { display: block; }
        .search-kbd { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 9px; color: #536471; background: #1e2732; border: 1px solid #3d5466; padding: 1px 5px; border-radius: 3px; pointer-events: none; }
        .search-wrap.has-value .search-kbd { display: none; }
        .agency-select { padding: 7px 8px; background: #273340; border: 1px solid #3d5466; border-radius: 6px; color: #e7e9ea; font-size: 12px; min-width: 130px; }
        .agency-select:focus { outline: none; border-color: #1d9bf0; }
        .sidebar-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #3d5466 transparent; }
        .sidebar-list::-webkit-scrollbar { width: 5px; }
        .sidebar-list::-webkit-scrollbar-track { background: transparent; }
        .sidebar-list::-webkit-scrollbar-thumb { background: #3d5466; border-radius: 3px; }
        .sidebar-list::-webkit-scrollbar-thumb:hover { background: #536471; }
        .adv-item { padding: 10px 14px; border-bottom: 1px solid #1e2732; cursor: pointer; transition: background 0.15s, border-left 0.15s; border-left: 3px solid transparent; }
        .adv-item:hover { background: #1e2732; }
        .adv-item.active { background: #1d3a4d; border-left: 3px solid #1d9bf0; }
        .adv-name { font-size: 13px; font-weight: 600; margin-bottom: 3px; display: flex; justify-content: space-between; align-items: center; }
        .adv-agency { font-size: 11px; color: #8b98a5; margin-bottom: 4px; }
        .adv-domains { font-size: 11px; color: #6cdfe5; word-break: break-all; line-height: 1.4; }
        .adv-meta { display: flex; gap: 8px; margin-top: 5px; font-size: 10px; }
        .adv-meta .chip { padding: 2px 6px; border-radius: 3px; font-weight: 500; }
        .chip-green { background: rgba(0,186,124,0.15); color: #00ba7c; }
        .chip-blue { background: rgba(29,155,240,0.15); color: #1d9bf0; }
        .chip-yellow { background: rgba(247,147,26,0.15); color: #f7931a; }
        .chip-red { background: rgba(244,33,46,0.15); color: #f4212e; }
        .chip-muted { background: rgba(139,152,165,0.1); color: #8b98a5; }
        .setup-dots { display: flex; gap: 3px; align-items: center; }
        .setup-dot { width: 8px; height: 8px; border-radius: 50%; }
        .setup-dot.on { background: #00ba7c; }
        .setup-dot.off { background: #3d5466; }
        .sidebar-footer { padding: 10px 14px; border-top: 1px solid #2f3942; display: flex; gap: 6px; }

        /* Right content */
        .content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; scrollbar-width: thin; scrollbar-color: #3d5466 transparent; }
        .content::-webkit-scrollbar { width: 5px; }
        .content::-webkit-scrollbar-track { background: transparent; }
        .content::-webkit-scrollbar-thumb { background: #3d5466; border-radius: 3px; }
        .content-empty { display: flex; justify-content: center; align-items: center; flex: 1; color: #8b98a5; font-size: 14px; flex-direction: column; gap: 12px; }
        .content-empty .empty-icon { font-size: 36px; opacity: 0.4; }
        .content-header { padding: 14px 20px; background: #16202a; border-bottom: 1px solid #2f3942; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .content-header h2 { font-size: 16px; font-weight: 700; }
        .content-header .adv-id { font-size: 12px; color: #8b98a5; margin-left: 8px; }

        /* Tabs inside content */
        .content-tabs { display: flex; gap: 0; padding: 0 20px; background: #16202a; border-bottom: 1px solid #2f3942; flex-shrink: 0; }
        .ctab { padding: 10px 18px; background: none; border: none; color: #8b98a5; cursor: pointer; font-size: 13px; font-weight: 500; border-bottom: 2px solid transparent; }
        .ctab:hover { color: #e7e9ea; }
        .ctab.active { color: #1d9bf0; border-bottom-color: #1d9bf0; }
        .ctab .count { font-size: 10px; background: #273340; padding: 1px 5px; border-radius: 8px; margin-left: 4px; }

        /* Content panels */
        .cpanel { display: none; padding: 16px 20px; flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #3d5466 transparent; }
        .cpanel::-webkit-scrollbar { width: 5px; }
        .cpanel::-webkit-scrollbar-track { background: transparent; }
        .cpanel::-webkit-scrollbar-thumb { background: #3d5466; border-radius: 3px; }
        .cpanel.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: #1e2732; border-radius: 10px; overflow: hidden; margin-bottom: 14px; border: 1px solid transparent; transition: border-color 0.2s; }
        .card:hover { border-color: #2f3942; }
        .card-header { padding: 12px 16px; font-weight: 600; font-size: 13px; border-bottom: 1px solid #2f3942; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 14px 16px; }
        .card-body-compact { padding: 0; }

        /* Summary row */
        .summary-row { display: flex; gap: 12px; margin-bottom: 14px; }
        .summary-card { flex: 1; background: #1e2732; border-radius: 8px; padding: 12px 14px; border: 1px solid transparent; transition: border-color 0.2s, transform 0.15s; }
        .summary-card:hover { border-color: #2f3942; transform: translateY(-1px); }
        .summary-label { font-size: 10px; color: #8b98a5; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
        .summary-value { font-size: 20px; font-weight: 700; }
        .summary-sub { font-size: 11px; color: #8b98a5; margin-top: 2px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 8px 14px; font-size: 10px; color: #8b98a5; text-transform: uppercase; background: #16202a; font-weight: 600; letter-spacing: 0.3px; }
        td { padding: 9px 14px; border-bottom: 1px solid #2f3942; font-size: 12px; }
        tr:last-child td { border-bottom: none; }
        tbody tr { transition: background 0.1s; }
        tbody tr:hover { background: #252e38; }
        .text-right { text-align: right; }
        .text-green { color: #00ba7c; }
        .text-blue { color: #1d9bf0; }
        .text-yellow { color: #f7931a; }
        .text-red { color: #f4212e; }
        .text-muted { color: #8b98a5; }
        .text-cyan { color: #6cdfe5; }
        .truncate { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle; }

        /* Status badges */
        .badge { font-size: 10px; padding: 2px 7px; border-radius: 4px; font-weight: 600; }
        .badge-green { background: rgba(0,186,124,0.15); color: #00ba7c; }
        .badge-yellow { background: rgba(247,147,26,0.15); color: #f7931a; }
        .badge-red { background: rgba(244,33,46,0.15); color: #f4212e; }
        .badge-blue { background: rgba(29,155,240,0.15); color: #1d9bf0; }
        .badge-muted { background: rgba(139,152,165,0.1); color: #8b98a5; }

        /* Setup progress bar */
        .setup-bar { display: flex; gap: 4px; align-items: center; }
        .setup-step { flex: 1; height: 6px; border-radius: 3px; background: #273340; }
        .setup-step.done { background: #00ba7c; }
        .setup-step.partial { background: #f7931a; }
        .setup-label { font-size: 10px; color: #8b98a5; margin-left: 6px; white-space: nowrap; }

        /* Buttons */
        .btn { padding: 6px 12px; border-radius: 5px; border: none; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.15s; }
        .btn-primary { background: #1d9bf0; color: #fff; }
        .btn-primary:hover { background: #1a8cd8; }
        .btn-secondary { background: #273340; color: #e7e9ea; border: 1px solid #3d5466; }
        .btn-secondary:hover { border-color: #1d9bf0; }
        .btn-success { background: #00ba7c; color: #fff; }
        .btn-success:hover { background: #00a66d; }
        .btn-danger { background: #f4212e; color: #fff; }
        .btn-danger:hover { background: #d91c27; }
        .btn-sm { padding: 4px 8px; font-size: 10px; }
        .btn-group { display: flex; gap: 5px; }

        /* Domain tags */
        .domain-tag { display: inline-block; padding: 2px 8px; background: #273340; border-radius: 4px; font-size: 11px; margin: 2px 2px; color: #6cdfe5; }
        .domain-tag .remove { color: #8b98a5; cursor: pointer; margin-left: 4px; font-size: 12px; }
        .domain-tag .remove:hover { color: #f4212e; }

        /* POI brand tags */
        .poi-tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: #273340; border-radius: 4px; font-size: 11px; margin: 2px; }
        .poi-tag .brand-name { color: #e7e9ea; font-weight: 500; }
        .poi-tag .poi-count { color: #8b98a5; }

        /* Loading / Empty */
        .loading { display: flex; justify-content: center; align-items: center; padding: 30px; color: #8b98a5; font-size: 12px; gap: 8px; }
        .spinner { width: 16px; height: 16px; border: 2px solid #2f3942; border-top-color: #1d9bf0; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 30px; color: #8b98a5; font-size: 12px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.15s ease; }
        .modal { background: #1e2732; border-radius: 12px; border: 1px solid #3d5466; width: 560px; max-width: 90vw; max-height: 80vh; overflow-y: auto; animation: slideUp 0.2s ease; box-shadow: 0 16px 48px rgba(0,0,0,0.4); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { padding: 16px 18px; border-bottom: 1px solid #2f3942; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 15px; font-weight: 600; }
        .modal-close { background: none; border: none; color: #8b98a5; font-size: 18px; cursor: pointer; }
        .modal-close:hover { color: #e7e9ea; }
        .modal-body { padding: 16px 18px; }
        .modal-footer { padding: 12px 18px; border-top: 1px solid #2f3942; display: flex; justify-content: flex-end; gap: 8px; }
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 11px; color: #8b98a5; margin-bottom: 4px; font-weight: 500; }
        .form-input { width: 100%; padding: 8px 10px; background: #273340; border: 1px solid #3d5466; border-radius: 5px; color: #e7e9ea; font-size: 12px; transition: border-color 0.15s, box-shadow 0.15s; }
        .form-input:focus { outline: none; border-color: #1d9bf0; box-shadow: 0 0 0 2px rgba(29,155,240,0.15); }
        .form-input::placeholder { color: #536471; }
        select.form-input { appearance: auto; }

        /* Autocomplete */
        .autocomplete-wrap { position: relative; }
        .autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: #273340; border: 1px solid #3d5466; border-top: none; border-radius: 0 0 6px 6px; max-height: 250px; overflow-y: auto; z-index: 10; display: none; }
        .autocomplete-results.show { display: block; }
        .ac-item { padding: 7px 10px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #2f3942; }
        .ac-item:hover { background: #1d3a4d; }
        .ac-item .sub { font-size: 10px; color: #8b98a5; }

        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 18px; border-radius: 8px; font-size: 12px; font-weight: 500; z-index: 2000; transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #00ba7c; color: #fff; }
        .toast.error { background: #f4212e; color: #fff; }
        .toast.info { background: #1d9bf0; color: #fff; }

        /* Config grid */
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .config-item { padding: 8px 0; }
        .config-item .label { font-size: 10px; color: #8b98a5; text-transform: uppercase; margin-bottom: 2px; }
        .config-item .value { font-size: 13px; }

        /* Campaign setup status grid */
        .campaign-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .campaign-card { background: #16202a; border-radius: 8px; padding: 12px 14px; border: 1px solid #2f3942; }
        .campaign-card:hover { border-color: #3d5466; }
        .campaign-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .campaign-meta { font-size: 11px; color: #8b98a5; display: flex; gap: 12px; margin-bottom: 8px; }

        /* File upload area */
        .upload-area { border: 2px dashed #3d5466; border-radius: 8px; padding: 24px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
        .upload-area:hover { border-color: #1d9bf0; background: rgba(29,155,240,0.03); }
        .upload-area.dragover { border-color: #1d9bf0; background: rgba(29,155,240,0.08); }
        .upload-area input { display: none; }

        /* Loading skeleton */
        .skeleton { background: linear-gradient(90deg, #1e2732 25%, #273340 50%, #1e2732 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skel-line { height: 12px; margin-bottom: 8px; }
        .skel-line:last-child { width: 60%; }

        /* Responsive: narrow screens */
        @media (max-width: 900px) {
            .sidebar { width: 320px; min-width: 320px; }
        }
        @media (max-width: 700px) {
            .sidebar { width: 280px; min-width: 280px; }
            .summary-row { flex-wrap: wrap; }
            .summary-card { min-width: calc(50% - 6px); }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="btn btn-secondary btn-sm" onclick="toggleSidebar()" title="Toggle sidebar (‚åò\)" style="font-size:14px;padding:4px 8px;line-height:1;">‚ò∞</button>
                <a href="/" class="back-link">‚Üê Optimizer</a>
                <a href="/"><img src="/quorum-logo.svg" alt="Quorum" style="max-height:26px;"></a>
                <div class="top-bar-title"><span>Advertiser</span> Hub</div>
            </div>
            <div class="top-bar-right">
                <div class="user-info" id="userInfo"></div>
                <button class="btn btn-secondary" onclick="location.href='/'" style="font-size:11px">Dashboard</button>
            </div>
        </div>

        <div class="main">
            <!-- Left Sidebar: Advertiser List -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>Advertisers <span id="advCount" class="text-muted" style="font-weight:normal;font-size:11px"></span></h3>
                    <div class="sidebar-filters">
                        <select class="agency-select" id="agencyFilter" onchange="loadAdvertiserList()">
                            <option value="">All Agencies</option>
                        </select>
                    </div>
                    <div class="search-wrap" id="searchWrap">
                        <span class="search-icon">‚åï</span>
                        <input type="text" class="sidebar-search" id="advSearch" placeholder="Search advertisers..." oninput="handleSearchInput()">
                        <button class="search-clear" onclick="clearSearch()" title="Clear">&times;</button>
                        <span class="search-kbd">‚åòK</span>
                    </div>
                </div>
                <div class="sidebar-list" id="advList">
                    <div class="loading"><div class="spinner"></div> Loading...</div>
                </div>
                <div class="sidebar-footer">
                    <button class="btn btn-primary" onclick="openCreateAdvertiser()" style="flex:1">+ New Advertiser</button>
                    <button class="btn btn-secondary" onclick="openDiscovery()" title="Search impression logs to find unmapped advertisers">üîç Discovery</button>
                </div>
            </div>

            <!-- Right Content: Advertiser Detail -->
            <div class="content" id="contentArea">
                <div class="content-empty" id="emptyState">
                    <div class="empty-icon">‚ö°</div>
                    <div>Select an advertiser to view details</div>
                    <div style="font-size:12px;color:#536471;">Or create a new one from the sidebar</div>
                </div>
                <div id="detailView" style="display:none; flex-direction:column;">
                    <div class="content-header">
                        <div>
                            <h2 id="detailName">‚Äî</h2>
                            <span class="text-muted" style="font-size:11px" id="detailMeta"></span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="openEditConfig()">Edit Config</button>
                            <button class="btn btn-secondary btn-sm" onclick="refreshDetail()">‚Üª</button>
                        </div>
                    </div>

                    <div class="content-tabs">
                        <button class="ctab active" data-tab="overview" onclick="switchContentTab(this)">Overview</button>
                        <button class="ctab" data-tab="campaigns" onclick="switchContentTab(this)">Campaigns <span class="count" id="tabCampaignCount">0</span></button>
                        <button class="ctab" data-tab="pois" onclick="switchContentTab(this)">POI Locations <span class="count" id="tabPoiCount">0</span></button>
                        <button class="ctab" data-tab="discovery" onclick="switchContentTab(this)">Discovery</button>
                    </div>

                    <!-- Overview Tab -->
                    <div class="cpanel active" id="tab-overview">
                        <!-- Setup Progress -->
                        <div class="card" style="margin-bottom:14px">
                            <div class="card-header">Setup Progress</div>
                            <div class="card-body">
                                <div class="setup-bar" id="setupBar"></div>
                                <div id="setupSteps" style="margin-top:8px;font-size:11px;color:#8b98a5;"></div>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="summary-row" id="summaryRow">
                            <div class="summary-card">
                                <div class="summary-label">Campaigns</div>
                                <div class="summary-value text-blue" id="sumCampaigns">0</div>
                                <div class="summary-sub" id="sumImpressions"></div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">Web Pixel URLs</div>
                                <div class="summary-value text-cyan" id="sumDomains">0</div>
                                <div class="summary-sub" id="sumDomainsSub"></div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">POI Locations</div>
                                <div class="summary-value text-green" id="sumPois">0</div>
                                <div class="summary-sub" id="sumPoisSub"></div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">Attribution Window</div>
                                <div class="summary-value" id="sumWindow">30d</div>
                                <div class="summary-sub" id="sumStrategy"></div>
                            </div>
                        </div>

                        <!-- Domains Section -->
                        <div class="card">
                            <div class="card-header">
                                Web Pixel Domains
                                <button class="btn btn-sm btn-primary" onclick="openAddDomain()">+ Add Domain</button>
                            </div>
                            <div class="card-body" id="domainsList">
                                <div class="empty">No domains configured</div>
                            </div>
                        </div>

                        <!-- Config Details -->
                        <div class="card">
                            <div class="card-header">Configuration</div>
                            <div class="card-body">
                                <div class="config-grid" id="configGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Campaigns Tab -->
                    <div class="cpanel" id="tab-campaigns">
                        <div class="card">
                            <div class="card-header">
                                Campaigns & Line Items
                                <span class="text-muted" style="font-size:11px" id="campaignInfo"></span>
                            </div>
                            <div class="card-body-compact" id="campaignsList">
                                <div class="loading"><div class="spinner"></div> Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- POI Tab -->
                    <div class="cpanel" id="tab-pois">
                        <!-- POI Summary -->
                        <div class="summary-row" id="poiSummaryRow">
                            <div class="summary-card">
                                <div class="summary-label">Total Segments</div>
                                <div class="summary-value text-green" id="poiTotalSegs">0</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">Brands</div>
                                <div class="summary-value" id="poiBrandCount">0</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">DMAs</div>
                                <div class="summary-value" id="poiDmaCount">0</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">Total Locations</div>
                                <div class="summary-value" id="poiLocCount">0</div>
                            </div>
                        </div>

                        <!-- POI Actions -->
                        <div class="card">
                            <div class="card-header">
                                Assigned POIs
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary" onclick="openPoiSearch()">+ Search & Add</button>
                                    <button class="btn btn-sm btn-secondary" onclick="openStoreUpload()">Upload Store List</button>
                                </div>
                            </div>
                            <div class="card-body-compact" id="poiList">
                                <div class="loading"><div class="spinner"></div> Loading...</div>
                            </div>
                        </div>

                        <!-- POI Search (hidden until opened) -->
                        <div class="card" id="poiSearchCard" style="display:none">
                            <div class="card-header">
                                Brand Search
                                <button class="btn btn-sm btn-secondary" onclick="document.getElementById('poiSearchCard').style.display='none'">Close</button>
                            </div>
                            <div class="card-body">
                                <div style="display:flex;gap:6px;margin-bottom:10px;">
                                    <input type="text" class="form-input" id="poiBrandInput" placeholder="Brand name (e.g. Starbucks, Target...)" onkeydown="if(event.key==='Enter') searchBrands()">
                                    <input type="text" class="form-input" id="poiDmaInput" placeholder="DMA (optional)" style="max-width:160px" onkeydown="if(event.key==='Enter') searchBrands()">
                                    <button class="btn btn-primary" onclick="searchBrands()">Search</button>
                                </div>
                                <div id="poiSearchResults">
                                    <div class="empty">Search for a brand to find locations.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Store List Upload (hidden until opened) -->
                        <div class="card" id="storeUploadCard" style="display:none">
                            <div class="card-header">
                                Upload Store List
                                <button class="btn btn-sm btn-secondary" onclick="document.getElementById('storeUploadCard').style.display='none'">Close</button>
                            </div>
                            <div class="card-body">
                                <p style="font-size:12px;color:#8b98a5;margin-bottom:12px;">Upload a CSV with store addresses. This will be sent to cs@quorum.inc for processing via PolyPak.</p>
                                <div class="upload-area" id="uploadArea" onclick="document.getElementById('storeFileInput').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleFileDrop(event)">
                                    <input type="file" id="storeFileInput" accept=".csv,.xlsx,.xls,.tsv" onchange="handleFileSelect(this)">
                                    <div style="font-size:13px;margin-bottom:4px;">Drop CSV here or click to browse</div>
                                    <div style="font-size:11px;color:#8b98a5;">Accepted: .csv, .xlsx, .xls, .tsv</div>
                                </div>
                                <div id="uploadStatus" style="margin-top:10px;display:none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Discovery Tab -->
                    <div class="cpanel" id="tab-discovery">
                        <div class="card">
                            <div class="card-header">
                                Impression Log Search
                                <span class="text-muted" style="font-size:11px;">Discover new advertisers from ad impressions</span>
                            </div>
                            <div class="card-body">
                                <div style="display:flex;gap:6px;margin-bottom:12px;">
                                    <select class="form-input" id="discAgency" style="max-width:200px">
                                        <option value="">Select agency...</option>
                                    </select>
                                    <select class="form-input" id="discDays" style="max-width:120px">
                                        <option value="7">Last 7 days</option>
                                        <option value="14">Last 14 days</option>
                                        <option value="30" selected>Last 30 days</option>
                                        <option value="60">Last 60 days</option>
                                    </select>
                                    <input type="number" class="form-input" id="discMinImpr" value="100" placeholder="Min impressions" style="max-width:130px">
                                    <button class="btn btn-primary" onclick="searchImpressions()">Search</button>
                                </div>
                                <div id="discoveryResults">
                                    <div class="empty">Select an agency and search to discover new advertisers from impression logs.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Create Advertiser -->
    <div class="modal-overlay" id="modalCreate">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Advertiser</div>
                <button class="modal-close" onclick="closeModal('modalCreate')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="form-label">Advertiser Name</div>
                    <input type="text" class="form-input" id="createName" placeholder="e.g. Acme Corporation">
                </div>
                <div class="form-group">
                    <div class="form-label">Agency</div>
                    <select class="form-input" id="createAgency"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalCreate')">Cancel</button>
                <button class="btn btn-success" onclick="submitCreateAdvertiser()">Create Advertiser</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Domain -->
    <div class="modal-overlay" id="modalDomain">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add Web Pixel Domain</div>
                <button class="modal-close" onclick="closeModal('modalDomain')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="form-label">Domain URL</div>
                    <input type="text" class="form-input" id="addDomainUrl" placeholder="e.g. www.example.com">
                </div>
                <div class="form-group">
                    <div class="form-label">Is this a POI/store locator URL?</div>
                    <select class="form-input" id="addDomainIsPoi">
                        <option value="false">No ‚Äî Web pixel tracking</option>
                        <option value="true">Yes ‚Äî Store locator page</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalDomain')">Cancel</button>
                <button class="btn btn-success" onclick="submitAddDomain()">Add Domain</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Config -->
    <div class="modal-overlay" id="modalConfig">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Edit Configuration</div>
                <button class="modal-close" onclick="closeModal('modalConfig')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <div class="form-label">Attribution Window (days)</div>
                        <input type="number" class="form-input" id="editAttrWindow" min="1" max="90">
                    </div>
                    <div class="form-group">
                        <div class="form-label">Match Strategy</div>
                        <select class="form-input" id="editMatchStrategy">
                            <option value="HOUSEHOLD">HOUSEHOLD</option>
                            <option value="DEVICE">DEVICE</option>
                            <option value="IP_ONLY">IP_ONLY</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Impression Join Strategy</div>
                        <select class="form-input" id="editImprStrategy">
                            <option value="PCM_4KEY">PCM_4KEY ‚Äî 4-Key Match</option>
                            <option value="ADM_PREFIX">ADM_PREFIX ‚Äî Domain Mapping</option>
                            <option value="DIRECT_AG">DIRECT_AG ‚Äî Agency Match</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Config Status</div>
                        <select class="form-input" id="editStatus">
                            <option value="ACTIVE">ACTIVE</option>
                            <option value="INACTIVE">INACTIVE</option>
                            <option value="PENDING">PENDING</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalConfig')">Cancel</button>
                <button class="btn btn-success" onclick="submitEditConfig()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Modal: Map Campaign (from discovery) -->
    <div class="modal-overlay" id="modalMap">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Map Campaign to Advertiser</div>
                <button class="modal-close" onclick="closeModal('modalMap')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="form-label">DSP Advertiser</div>
                    <div style="font-size:13px;padding:6px 0;" id="mapDspName"></div>
                </div>
                <div class="form-group">
                    <div class="form-label">Platform</div>
                    <div style="font-size:13px;padding:6px 0;" id="mapPlatform"></div>
                </div>
                <div class="form-group">
                    <div class="form-label">Impressions</div>
                    <div style="font-size:13px;padding:6px 0;color:#f7931a" id="mapImpressions"></div>
                </div>
                <div class="form-group">
                    <div class="form-label">Map to Quorum Advertiser</div>
                    <div class="autocomplete-wrap">
                        <input type="text" class="form-input" id="mapAdvSearch" placeholder="Search advertiser..." oninput="searchAdvForMap()">
                        <div class="autocomplete-results" id="mapAdvResults"></div>
                    </div>
                    <input type="hidden" id="mapAdvId">
                    <div id="mapAdvSelected" style="margin-top:6px;font-size:12px;color:#00ba7c;display:none"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalMap')">Cancel</button>
                <button class="btn btn-success" onclick="submitMapCampaign()">Map Campaign</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    // =========================================================================
    // STATE
    // =========================================================================
    const API = window.location.origin;
    const fmt = n => n != null ? Number(n).toLocaleString() : '0';
    const esc = s => s == null ? '' : String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    let _clerk = null, _authToken = null, _userRole = 'agency', _userAgencyId = null;
    let currentAdvId = null, currentAgencyId = null, currentDetail = null;
    let agencies = [];
    let _mapData = {};

    // =========================================================================
    // AUTH
    // =========================================================================
    async function initAuth() {
        try {
            const cfgRes = await fetch(API + '/api/auth/config');
            const cfg = await cfgRes.json();
            if (!cfg.auth_enabled) return;

            function getFapiUrl(pk) {
                const encoded = pk.replace('pk_test_', '').replace('pk_live_', '');
                try { return atob(encoded).replace(/\$$/, ''); } catch(e) { return null; }
            }
            const fapiUrl = getFapiUrl(cfg.publishable_key);
            if (!fapiUrl) return;

            await new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = `https://${fapiUrl}/npm/@clerk/clerk-js@5/dist/clerk.browser.js`;
                s.crossOrigin = 'anonymous';
                s.setAttribute('data-clerk-publishable-key', cfg.publishable_key);
                s.onload = resolve; s.onerror = reject;
                document.head.appendChild(s);
            });
            _clerk = window.Clerk;
            if (!_clerk) return;
            if (typeof _clerk.load === 'function') await _clerk.load();
            if (!_clerk.user) { window.location.href = '/login'; return; }
            _authToken = await _clerk.session.getToken();
            setInterval(async () => { if (_clerk?.session) _authToken = await _clerk.session.getToken(); }, 50000);

            // Check role
            const meRes = await authFetch(API + '/api/auth/me');
            if (meRes.ok) {
                const me = await meRes.json();
                _userRole = me.role || 'agency';
                _userAgencyId = me.agency_id;
                document.getElementById('userInfo').innerHTML =
                    `${esc(me.email || '')} <span class="role">${esc(me.role || '')}</span>`;

                if (!['admin', 'account_admin'].includes(_userRole)) {
                    document.body.innerHTML = '<div style="padding:40px;text-align:center;color:#f4212e;">Access requires admin or account admin role. <a href="/" style="color:#1d9bf0;">Back to dashboard</a></div>';
                    return;
                }
            }
        } catch (e) {
            console.warn('[Auth] Init failed:', e);
        }
    }

    function authFetch(url, opts = {}) {
        if (_authToken) {
            opts.headers = opts.headers || {};
            opts.headers['Authorization'] = 'Bearer ' + _authToken;
        }
        return fetch(url, opts);
    }

    // Override fetch for API calls
    const _realFetch = window.fetch;
    window.fetch = function(url, opts) {
        const urlStr = typeof url === 'string' ? url : url.toString();
        if (urlStr.includes('/api/') && _authToken) {
            opts = opts || {};
            opts.headers = opts.headers || {};
            if (typeof opts.headers === 'object' && !(opts.headers instanceof Headers)) {
                opts.headers['Authorization'] = 'Bearer ' + _authToken;
            }
        }
        return _realFetch(url, opts);
    };

    // =========================================================================
    // HELPERS
    // =========================================================================
    let _searchTimer = null;
    function handleSearchInput() {
        const wrap = document.getElementById('searchWrap');
        const val = document.getElementById('advSearch').value;
        wrap.classList.toggle('has-value', val.length > 0);
        clearTimeout(_searchTimer);
        _searchTimer = setTimeout(() => loadAdvertiserList(), 300);
    }
    function clearSearch() {
        document.getElementById('advSearch').value = '';
        document.getElementById('searchWrap').classList.remove('has-value');
        loadAdvertiserList();
        document.getElementById('advSearch').focus();
    }
    function toggleSidebar() {
        document.querySelector('.sidebar').classList.toggle('collapsed');
    }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg, type='success') {
        const t = document.getElementById('toast');
        t.textContent = msg; t.className = 'toast ' + type + ' show';
        setTimeout(() => t.classList.remove('show'), 4000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
        // Cmd/Ctrl+K ‚Üí focus search
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            const sidebar = document.querySelector('.sidebar');
            if (sidebar.classList.contains('collapsed')) sidebar.classList.remove('collapsed');
            document.getElementById('advSearch').focus();
            document.getElementById('advSearch').select();
        }
        // Cmd/Ctrl+\ ‚Üí toggle sidebar
        if ((e.metaKey || e.ctrlKey) && e.key === '\\') {
            e.preventDefault();
            toggleSidebar();
        }
        // Escape ‚Üí close modals
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
    });

    // =========================================================================
    // AGENCIES LOAD
    // =========================================================================
    async function loadAgencies() {
        try {
            const res = await fetch(API + '/api/config/agencies');
            const json = await res.json();
            if (json.success) {
                agencies = json.data;
                const selectors = ['agencyFilter', 'createAgency', 'discAgency'];
                selectors.forEach(selId => {
                    const sel = document.getElementById(selId);
                    if (!sel) return;
                    const firstOpt = sel.options[0]?.outerHTML || '';
                    sel.innerHTML = firstOpt;
                    agencies.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.AGENCY_ID;
                        opt.textContent = `${a.AGENCY_NAME || ''} (${a.AGENCY_ID})`;
                        sel.appendChild(opt);
                    });
                });
                // If user is agency-locked, set and disable filter
                if (_userAgencyId && _userRole !== 'admin') {
                    document.getElementById('agencyFilter').value = _userAgencyId;
                    document.getElementById('agencyFilter').disabled = true;
                }
            }
        } catch(e) { console.error('Failed to load agencies:', e); }
    }

    // =========================================================================
    // ADVERTISER LIST (sidebar)
    // =========================================================================
    async function loadAdvertiserList() {
        const container = document.getElementById('advList');
        container.innerHTML = Array(6).fill(`<div style="padding:12px 14px;border-bottom:1px solid #1e2732;">
            <div class="skeleton skel-line" style="width:70%"></div>
            <div class="skeleton skel-line" style="width:40%;height:10px;"></div>
            <div class="skeleton skel-line" style="width:90%;height:10px;"></div>
        </div>`).join('');

        try {
            const agencyId = document.getElementById('agencyFilter').value || (_userAgencyId || '');
            const search = document.getElementById('advSearch').value.trim();
            let url = API + '/api/config/advertiser-hub?limit=200';
            if (agencyId) url += `&agency_id=${agencyId}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;

            const res = await fetch(url);
            const json = await res.json();
            if (!json.success) { container.innerHTML = `<div class="empty">${esc(json.error)}</div>`; return; }

            document.getElementById('advCount').textContent = `(${json.count})`;

            if (json.count === 0) {
                container.innerHTML = '<div class="empty">No advertisers found. Create one or adjust filters.</div>';
                return;
            }

            container.innerHTML = json.data.map(r => {
                const isActive = currentAdvId === r.ADVERTISER_ID;
                const setupScore = r.SETUP_SCORE || 0;
                const domains = (r.DOMAINS || '').split(', ').filter(Boolean).slice(0, 2);
                const domainChips = domains.map(d =>
                    `<span style="display:inline-block;padding:1px 6px;background:rgba(108,223,229,0.08);border-radius:3px;font-size:10px;color:#6cdfe5;margin-right:3px;">${esc(d)}</span>`
                ).join('') + (r.DOMAIN_COUNT > 2 ? `<span style="font-size:10px;color:#536471;">+${r.DOMAIN_COUNT - 2}</span>` : '');

                return `<div class="adv-item ${isActive ? 'active' : ''}" onclick="selectAdvertiser(${r.ADVERTISER_ID}, ${r.AGENCY_ID})">
                    <div class="adv-name">
                        ${esc(r.ADVERTISER_NAME || 'Unknown')}
                        <div class="setup-dots" title="${setupScore}/3 setup steps complete">
                            <div class="setup-dot ${r.CAMPAIGN_COUNT > 0 ? 'on' : 'off'}" title="Campaigns"></div>
                            <div class="setup-dot ${r.DOMAIN_COUNT > 0 ? 'on' : 'off'}" title="Domains"></div>
                            <div class="setup-dot ${r.POI_COUNT > 0 ? 'on' : 'off'}" title="POIs"></div>
                        </div>
                    </div>
                    <div class="adv-agency">${esc(r.AGENCY_NAME || '')} ¬∑ ID ${r.ADVERTISER_ID}</div>
                    ${domains.length > 0 ? `<div style="margin:3px 0;">${domainChips}</div>` : ''}
                    <div class="adv-meta">
                        ${r.CAMPAIGN_COUNT > 0 ? `<span class="chip chip-blue">${r.CAMPAIGN_COUNT} camp</span>` : ''}
                        ${r.POI_COUNT > 0 ? `<span class="chip chip-green">${r.POI_COUNT} POIs</span>` : ''}
                        ${r.TOTAL_IMPRESSIONS_14D > 0 ? `<span class="chip chip-yellow">${fmt(r.TOTAL_IMPRESSIONS_14D)} impr</span>` : ''}
                        ${!r.CAMPAIGN_COUNT && !r.POI_COUNT ? `<span class="chip chip-muted">Needs setup</span>` : ''}
                    </div>
                </div>`;
            }).join('');

        } catch(e) {
            container.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
        }
    }

    // =========================================================================
    // SELECT ADVERTISER ‚Üí Load Detail
    // =========================================================================
    async function selectAdvertiser(advId, agencyId) {
        currentAdvId = advId;
        currentAgencyId = agencyId;

        // Highlight in sidebar
        document.querySelectorAll('.adv-item').forEach(el => el.classList.remove('active'));
        event?.target?.closest?.('.adv-item')?.classList?.add('active');

        // Show detail view
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('detailView').style.display = 'flex';

        // Restore all tabs (in case Discovery mode hid them)
        document.querySelectorAll('.ctab').forEach(t => { t.classList.remove('active'); t.style.display = ''; });
        document.querySelectorAll('.cpanel').forEach(p => p.classList.remove('active'));
        document.querySelector('.ctab[data-tab="overview"]').classList.add('active');
        document.getElementById('tab-overview').classList.add('active');

        await loadDetail(advId, agencyId);
    }

    async function loadDetail(advId, agencyId) {
        try {
            const res = await fetch(`${API}/api/config/advertiser-detail?advertiser_id=${advId}&agency_id=${agencyId}`);
            const json = await res.json();
            if (!json.success) { showToast(json.error, 'error'); return; }

            currentDetail = json;
            const cfg = json.config || {};

            // Header
            document.getElementById('detailName').textContent = cfg.ADVERTISER_NAME || 'Unknown';
            document.getElementById('detailMeta').textContent =
                `ID: ${cfg.ADVERTISER_ID} ¬∑ Agency: ${cfg.AGENCY_NAME || cfg.AGENCY_ID} ¬∑ Status: ${cfg.CONFIG_STATUS || 'UNCONFIGURED'}`;

            // Tab counts
            document.getElementById('tabCampaignCount').textContent = json.campaigns?.length || 0;
            document.getElementById('tabPoiCount').textContent = json.pois?.length || 0;

            // Setup progress
            renderSetupProgress(json);

            // Summary cards
            document.getElementById('sumCampaigns').textContent = json.campaigns?.length || 0;
            const totalImpr = json.campaigns?.reduce((s, c) => s + (c.IMPRESSIONS_14DAY_ROLLING || 0), 0) || 0;
            document.getElementById('sumImpressions').textContent = totalImpr > 0 ? `${fmt(totalImpr)} impr (14d)` : 'No recent impressions';

            document.getElementById('sumDomains').textContent = json.domains?.length || 0;
            document.getElementById('sumDomainsSub').textContent = json.domains?.length > 0 ? 'Web visit attribution enabled' : 'No domains configured';

            const poiSum = json.poi_summary || {};
            document.getElementById('sumPois').textContent = poiSum.total_segments || 0;
            document.getElementById('sumPoisSub').textContent = poiSum.unique_brands > 0
                ? `${poiSum.unique_brands} brands ¬∑ ${poiSum.unique_dmas} DMAs ¬∑ ${fmt(poiSum.total_locations)} locations`
                : 'No POIs assigned';

            document.getElementById('sumWindow').textContent = (cfg.ATTRIBUTION_WINDOW_DAYS || 30) + 'd';
            document.getElementById('sumStrategy').textContent = cfg.MATCH_STRATEGY || 'HOUSEHOLD';

            // Domains list
            renderDomains(json.domains || []);

            // Config grid
            renderConfigGrid(cfg);

            // Campaigns
            renderCampaigns(json.campaigns || []);

            // POIs
            renderPois(json.pois || [], poiSum);

        } catch(e) {
            showToast('Failed to load: ' + e.message, 'error');
        }
    }

    function refreshDetail() {
        if (currentAdvId) loadDetail(currentAdvId, currentAgencyId);
    }

    // =========================================================================
    // RENDER: Setup Progress
    // =========================================================================
    function renderSetupProgress(detail) {
        const campaigns = detail.campaigns?.length > 0;
        const domains = detail.domains?.length > 0;
        const pois = detail.pois?.length > 0;
        const steps = [
            { label: 'Campaign Mappings', done: campaigns, action: 'Map campaigns from impression logs' },
            { label: 'Web Pixel URLs', done: domains, action: 'Add website domains for web visit tracking' },
            { label: 'POI Locations', done: pois, action: 'Assign store/location segments for foot traffic' },
        ];

        const bar = document.getElementById('setupBar');
        bar.innerHTML = steps.map(s => `<div class="setup-step ${s.done ? 'done' : ''}"></div>`).join('') +
            `<span class="setup-label">${steps.filter(s => s.done).length}/3 complete</span>`;

        const stepsDiv = document.getElementById('setupSteps');
        const incomplete = steps.filter(s => !s.done);
        if (incomplete.length > 0) {
            stepsDiv.innerHTML = '<strong style="color:#f7931a">Next steps:</strong> ' +
                incomplete.map(s => s.action).join(' ‚Üí ');
        } else {
            stepsDiv.innerHTML = '<span style="color:#00ba7c">All setup steps complete!</span>';
        }
    }

    // =========================================================================
    // RENDER: Domains
    // =========================================================================
    function renderDomains(domains) {
        const el = document.getElementById('domainsList');
        if (!domains.length) {
            el.innerHTML = '<div class="empty">No domains configured. Add a web pixel domain to enable web visit attribution.</div>';
            return;
        }
        el.innerHTML = domains.map(d => `
            <span class="domain-tag">
                ${esc(d.url)}${d.is_poi ? ' <span style="color:#f7931a;font-size:10px">POI</span>' : ''}
                <span class="remove" onclick="removeDomain('${esc(d.url)}')" title="Remove domain">&times;</span>
            </span>
        `).join('');
    }

    async function removeDomain(url) {
        if (!confirm(`Remove domain "${url}" from this advertiser?`)) return;
        try {
            const res = await fetch(API + '/api/config/remove-domain', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ advertiser_id: currentAdvId, agency_id: currentAgencyId, url })
            });
            const json = await res.json();
            if (json.success) { showToast('Domain removed'); refreshDetail(); }
            else showToast(json.error, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    // =========================================================================
    // RENDER: Config Grid
    // =========================================================================
    function renderConfigGrid(cfg) {
        const strategyLabels = { PCM_4KEY: 'PCM 4-Key', ADM_PREFIX: 'Domain Mapping', DIRECT_AG: 'Agency Match' };
        const statusColors = { ACTIVE: 'text-green', INACTIVE: 'text-red', PENDING: 'text-yellow' };
        const boolItem = (label, val) => [label, val
            ? '<span class="text-green" style="font-size:12px;">‚óè Enabled</span>'
            : '<span class="text-muted" style="font-size:12px;">‚óã Disabled</span>', true];
        const items = [
            ['Config Status', `<span class="${statusColors[cfg.CONFIG_STATUS] || 'text-muted'}">${cfg.CONFIG_STATUS || 'UNCONFIGURED'}</span>`, true],
            ['Attribution Window', (cfg.ATTRIBUTION_WINDOW_DAYS || 30) + ' days'],
            ['Match Strategy', cfg.MATCH_STRATEGY || 'HOUSEHOLD'],
            ['Impression Join', strategyLabels[cfg.IMPRESSION_JOIN_STRATEGY] || cfg.IMPRESSION_JOIN_STRATEGY || '‚Äî'],
            ['Exposure Source', cfg.EXPOSURE_SOURCE || '‚Äî'],
            ['Web Pixel Type', cfg.WEB_PIXEL_INTEGRATION_TYPE || '‚Äî'],
            boolItem('Store Visit', cfg.HAS_STORE_VISIT_ATTRIBUTION),
            boolItem('Web Visit', cfg.HAS_WEB_VISIT_ATTRIBUTION),
            boolItem('Impressions', cfg.HAS_IMPRESSION_TRACKING),
            ['Last Updated', cfg.UPDATED_AT ? new Date(cfg.UPDATED_AT).toLocaleString() : '‚Äî'],
        ];
        document.getElementById('configGrid').innerHTML = items.map(([label, val, isHtml]) => `
            <div class="config-item">
                <div class="label">${label}</div>
                <div class="value">${isHtml ? val : esc(String(val))}</div>
            </div>
        `).join('');
    }

    // =========================================================================
    // RENDER: Campaigns
    // =========================================================================
    function renderCampaigns(campaigns) {
        const el = document.getElementById('campaignsList');
        document.getElementById('campaignInfo').textContent = `${campaigns.length} campaign mappings`;

        if (!campaigns.length) {
            el.innerHTML = '<div class="empty">No campaign mappings. Go to Discovery tab to find and map campaigns.</div>';
            return;
        }

        let html = '<table><thead><tr><th>Campaign / Line Item</th><th>Platform</th><th class="text-right">Impressions (14d)</th><th class="text-right">Reach (14d)</th><th>Last Seen</th><th>Status</th></tr></thead><tbody>';
        campaigns.forEach(c => {
            const name = c.CAMPAIGN_NAME_MANUAL || c.INSERTION_ORDER_NAME_FROM_DSP || c.LINE_ITEM_NAME_FROM_DSP || c.ADVERTISER_NAME_FROM_DSP || '‚Äî';
            const impr = c.IMPRESSIONS_14DAY_ROLLING || 0;
            const reach = c.REACH_14DAY_ROLLING || 0;
            const lastSeen = c.LAST_IMPRESSION_TIMESTAMP ? new Date(c.LAST_IMPRESSION_TIMESTAMP).toLocaleDateString() : '‚Äî';
            const hasImpr = impr > 0;
            const hasDates = c.CAMPAIGN_START_DATE && c.CAMPAIGN_END_DATE;
            let status = 'Active', statusClass = 'badge-green';
            if (!hasImpr) { status = 'No data'; statusClass = 'badge-muted'; }

            html += `<tr>
                <td><span class="truncate" title="${esc(name)}">${esc(name)}</span></td>
                <td class="text-muted">${esc(c.DATA_SOURCE || c.DSP_PLATFORM_TYPE || '‚Äî')}</td>
                <td class="text-right ${hasImpr ? 'text-yellow' : 'text-muted'}">${fmt(impr)}</td>
                <td class="text-right text-muted">${fmt(reach)}</td>
                <td class="text-muted">${lastSeen}</td>
                <td><span class="badge ${statusClass}">${status}</span></td>
            </tr>`;
        });
        html += '</tbody></table>';
        el.innerHTML = html;
    }

    // =========================================================================
    // RENDER: POIs
    // =========================================================================
    function renderPois(pois, summary) {
        // Summary cards
        document.getElementById('poiTotalSegs').textContent = summary.total_segments || 0;
        document.getElementById('poiBrandCount').textContent = summary.unique_brands || 0;
        document.getElementById('poiDmaCount').textContent = summary.unique_dmas || 0;
        document.getElementById('poiLocCount').textContent = fmt(summary.total_locations || 0);

        const el = document.getElementById('poiList');
        if (!pois.length) {
            el.innerHTML = '<div class="empty">No POI segments assigned. Search and add brands, or upload a store list.</div>';
            return;
        }

        // Group by brand
        const byBrand = {};
        pois.forEach(p => {
            const brand = p.BRAND || 'Unknown';
            if (!byBrand[brand]) byBrand[brand] = [];
            byBrand[brand].push(p);
        });

        let html = '<table><thead><tr><th><input type="checkbox" id="poiSelectAll" onchange="togglePoiCheckboxes(this)"></th><th>Brand</th><th>DMA</th><th class="text-right">Locations</th><th class="text-right">Zips</th><th></th></tr></thead><tbody>';
        pois.forEach(p => {
            html += `<tr>
                <td><input type="checkbox" class="poi-cb" value="${esc(p.SEGMENT_MD5 || '')}"></td>
                <td>${esc(p.BRAND || 'Unknown')}</td>
                <td class="text-muted">${esc(p.DMA_NAME || '‚Äî')}</td>
                <td class="text-right">${fmt(p.LOCATIONS || 1)}</td>
                <td class="text-right text-muted">${fmt(p.ZIP_CODES || 0)}</td>
                <td><button class="btn btn-sm btn-danger" onclick="removePoi('${esc(p.SEGMENT_MD5)}')">Remove</button></td>
            </tr>`;
        });
        html += '</tbody></table>';

        // Add bulk remove button
        html = `<div style="padding:8px 14px;display:flex;justify-content:flex-end;gap:6px;border-bottom:1px solid #2f3942;">
            <button class="btn btn-sm btn-danger" onclick="removeSelectedPois()">Remove Selected</button>
        </div>` + html;

        el.innerHTML = html;
    }

    function togglePoiCheckboxes(el) {
        document.querySelectorAll('.poi-cb').forEach(cb => cb.checked = el.checked);
    }

    async function removePoi(md5) {
        if (!confirm('Remove this POI segment?')) return;
        try {
            const res = await fetch(API + '/api/config/remove-poi', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ advertiser_id: currentAdvId, agency_id: currentAgencyId, segment_md5s: [md5] })
            });
            const json = await res.json();
            if (json.success) { showToast('POI removed'); refreshDetail(); }
            else showToast(json.error, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    async function removeSelectedPois() {
        const checked = document.querySelectorAll('.poi-cb:checked');
        if (!checked.length) { showToast('Select POIs to remove', 'error'); return; }
        if (!confirm(`Remove ${checked.length} selected POI segments?`)) return;
        const md5s = Array.from(checked).map(cb => cb.value);
        try {
            const res = await fetch(API + '/api/config/remove-poi', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ advertiser_id: currentAdvId, agency_id: currentAgencyId, segment_md5s: md5s })
            });
            const json = await res.json();
            if (json.success) { showToast(`Removed ${json.deleted} POIs`); refreshDetail(); }
            else showToast(json.error, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    // =========================================================================
    // CONTENT TABS
    // =========================================================================
    function switchContentTab(el) {
        document.querySelectorAll('.ctab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.cpanel').forEach(p => p.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('tab-' + el.dataset.tab).classList.add('active');

        // Load discovery agency dropdown from current context
        if (el.dataset.tab === 'discovery' && currentAgencyId) {
            document.getElementById('discAgency').value = currentAgencyId;
        }
    }

    // =========================================================================
    // CREATE ADVERTISER
    // =========================================================================
    function openCreateAdvertiser() {
        document.getElementById('createName').value = '';
        const agencyVal = document.getElementById('agencyFilter').value;
        if (agencyVal) document.getElementById('createAgency').value = agencyVal;
        openModal('modalCreate');
    }

    async function submitCreateAdvertiser() {
        const name = document.getElementById('createName').value.trim();
        const agencyId = document.getElementById('createAgency').value;
        if (!name) { showToast('Enter advertiser name', 'error'); return; }
        if (!agencyId) { showToast('Select an agency', 'error'); return; }

        try {
            const res = await fetch(API + '/api/config/create-advertiser', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ advertiser_name: name, agency_id: parseInt(agencyId) })
            });
            const json = await res.json();
            closeModal('modalCreate');
            if (json.success) {
                showToast(json.message);
                loadAdvertiserList();
                // Select the new advertiser
                setTimeout(() => selectAdvertiser(json.advertiser_id, parseInt(agencyId)), 500);
            } else {
                showToast(json.error, 'error');
            }
        } catch(e) { showToast(e.message, 'error'); }
    }

    // =========================================================================
    // ADD DOMAIN
    // =========================================================================
    function openAddDomain() {
        document.getElementById('addDomainUrl').value = '';
        document.getElementById('addDomainIsPoi').value = 'false';
        openModal('modalDomain');
    }

    async function submitAddDomain() {
        const url = document.getElementById('addDomainUrl').value.trim();
        if (!url) { showToast('Enter a domain URL', 'error'); return; }

        try {
            const res = await fetch(API + '/api/config/configure-domain', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    advertiser_id: currentAdvId,
                    agency_id: currentAgencyId,
                    url: url,
                    is_poi: document.getElementById('addDomainIsPoi').value === 'true'
                })
            });
            const json = await res.json();
            closeModal('modalDomain');
            if (json.success) { showToast('Domain added'); refreshDetail(); loadAdvertiserList(); }
            else showToast(json.error, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    // =========================================================================
    // EDIT CONFIG
    // =========================================================================
    function openEditConfig() {
        if (!currentDetail?.config) return;
        const cfg = currentDetail.config;
        document.getElementById('editAttrWindow').value = cfg.ATTRIBUTION_WINDOW_DAYS || 30;
        document.getElementById('editMatchStrategy').value = cfg.MATCH_STRATEGY || 'HOUSEHOLD';
        document.getElementById('editImprStrategy').value = cfg.IMPRESSION_JOIN_STRATEGY || 'PCM_4KEY';
        document.getElementById('editStatus').value = cfg.CONFIG_STATUS || 'ACTIVE';
        openModal('modalConfig');
    }

    async function submitEditConfig() {
        try {
            const res = await fetch(API + '/api/config/update-config', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    advertiser_id: currentAdvId,
                    agency_id: currentAgencyId,
                    attribution_window_days: parseInt(document.getElementById('editAttrWindow').value) || 30,
                    match_strategy: document.getElementById('editMatchStrategy').value,
                    impression_join_strategy: document.getElementById('editImprStrategy').value,
                    config_status: document.getElementById('editStatus').value,
                })
            });
            const json = await res.json();
            closeModal('modalConfig');
            if (json.success) { showToast('Config updated'); refreshDetail(); }
            else showToast(json.error, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    // =========================================================================
    // POI SEARCH
    // =========================================================================
    function openPoiSearch() {
        document.getElementById('poiSearchCard').style.display = 'block';
        document.getElementById('poiBrandInput').focus();
    }

    async function searchBrands() {
        const brand = document.getElementById('poiBrandInput').value.trim();
        const dma = document.getElementById('poiDmaInput').value.trim();
        const container = document.getElementById('poiSearchResults');

        if (!brand && !dma) { container.innerHTML = '<div class="empty">Enter a brand name.</div>'; return; }
        container.innerHTML = '<div class="loading"><div class="spinner"></div> Searching...</div>';

        try {
            let url = `${API}/api/config/poi-brands?`;
            if (brand) url += `search=${encodeURIComponent(brand)}`;
            if (dma) url += `${brand ? '&' : ''}dma=${encodeURIComponent(dma)}`;

            const res = await fetch(url);
            const json = await res.json();
            if (!json.success) { container.innerHTML = `<div class="empty">${json.error}</div>`; return; }
            if (json.count === 0) { container.innerHTML = '<div class="empty">No matching brands found.</div>'; return; }

            let html = `<div style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                <span class="text-muted" style="font-size:11px">${json.count} results</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-secondary" onclick="document.querySelectorAll('.brand-cb').forEach(c=>c.checked=true)">Select All</button>
                    <button class="btn btn-sm btn-success" onclick="assignSelectedBrands()">Assign Selected</button>
                </div>
            </div>`;
            html += '<table><thead><tr><th style="width:30px"><input type="checkbox" onchange="document.querySelectorAll(\'.brand-cb\').forEach(c=>c.checked=this.checked)"></th><th>Brand</th><th>Category</th><th>DMA</th><th class="text-right">Locations</th></tr></thead><tbody>';
            json.data.forEach(r => {
                const md5 = r.SEGMENT_MD5 || r.MD5 || '';
                html += `<tr>
                    <td><input type="checkbox" class="brand-cb" value="${esc(md5)}" data-brand="${esc(r.BRAND || '')}" data-dma="${esc(r.DMA_NAME || '')}"></td>
                    <td>${esc(r.BRAND || '')}</td>
                    <td class="text-muted">${esc(r.CATEGORY || '')}</td>
                    <td>${esc(r.DMA_NAME || '')}</td>
                    <td class="text-right">${fmt(r.UNIQUE_LOCATIONS || 1)}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        } catch(e) {
            container.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
        }
    }

    async function assignSelectedBrands() {
        const checked = document.querySelectorAll('.brand-cb:checked');
        if (!checked.length) { showToast('Select at least one brand', 'error'); return; }

        const md5s = Array.from(checked).map(cb => cb.value);
        const brandName = checked[0].dataset.brand || '';
        const dma = checked[0].dataset.dma || '';

        try {
            const res = await fetch(API + '/api/config/assign-poi', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    advertiser_id: currentAdvId,
                    agency_id: currentAgencyId,
                    segment_md5s: md5s,
                    brand_name: brandName,
                    dma: dma
                })
            });
            const json = await res.json();
            if (json.success) {
                showToast(`Assigned ${json.inserted} segments (${json.skipped} already existed)`);
                refreshDetail();
                document.getElementById('poiSearchCard').style.display = 'none';
            } else {
                showToast(json.error, 'error');
            }
        } catch(e) { showToast(e.message, 'error'); }
    }

    // =========================================================================
    // STORE LIST UPLOAD
    // =========================================================================
    function openStoreUpload() {
        document.getElementById('storeUploadCard').style.display = 'block';
        document.getElementById('uploadStatus').style.display = 'none';
    }

    function handleFileDrop(e) {
        e.preventDefault();
        document.getElementById('uploadArea').classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) uploadStoreFile(e.dataTransfer.files[0]);
    }

    function handleFileSelect(input) {
        if (input.files.length > 0) uploadStoreFile(input.files[0]);
    }

    async function uploadStoreFile(file) {
        const status = document.getElementById('uploadStatus');
        status.style.display = 'block';
        status.innerHTML = '<div class="loading"><div class="spinner"></div> Uploading...</div>';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('advertiser_id', currentAdvId);
        formData.append('agency_id', currentAgencyId);
        formData.append('advertiser_name', currentDetail?.config?.ADVERTISER_NAME || '');

        try {
            const res = await fetch(API + '/api/config/upload-storelist', {
                method: 'POST',
                body: formData
            });
            const json = await res.json();
            if (json.success) {
                const emailNote = json.email_sent
                    ? '<span class="text-green">Email sent to cs@quorum.inc</span>'
                    : `<span class="text-yellow">Email not configured (SMTP not set up). Please manually notify cs@quorum.inc.</span>`;
                status.innerHTML = `<div style="padding:10px;background:#16202a;border-radius:6px;font-size:12px;">
                    <strong class="text-green">Uploaded: ${esc(json.filename)}</strong> (${json.rows} rows)<br>
                    ${emailNote}
                </div>`;
                showToast('Store list uploaded');
            } else {
                status.innerHTML = `<div class="text-red" style="font-size:12px">${json.error}</div>`;
            }
        } catch(e) {
            status.innerHTML = `<div class="text-red" style="font-size:12px">Upload failed: ${e.message}</div>`;
        }
    }

    // =========================================================================
    // DISCOVERY: Impression Log Search
    // =========================================================================
    function openDiscovery() {
        // If an advertiser is selected, switch to its discovery tab
        if (currentAdvId) {
            const tab = document.querySelector('.ctab[data-tab="discovery"]');
            switchContentTab(tab);
        } else {
            // Show detail view with just the discovery panel
            document.getElementById('emptyState').style.display = 'none';
            const dv = document.getElementById('detailView');
            dv.style.display = 'flex';
            document.getElementById('detailName').textContent = 'Discovery Mode';
            document.getElementById('detailMeta').textContent = 'Search impression logs to find and map new advertisers';
            document.querySelectorAll('.ctab').forEach(t => { t.classList.remove('active'); t.style.display = 'none'; });
            const discTab = document.querySelector('.ctab[data-tab="discovery"]');
            discTab.style.display = ''; discTab.classList.add('active');
            document.querySelectorAll('.cpanel').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-discovery').classList.add('active');
        }
    }

    async function searchImpressions() {
        const agencyId = document.getElementById('discAgency').value;
        if (!agencyId) { showToast('Select an agency', 'error'); return; }
        const days = document.getElementById('discDays').value;
        const minImpr = document.getElementById('discMinImpr').value || 100;
        const container = document.getElementById('discoveryResults');
        container.innerHTML = '<div class="loading"><div class="spinner"></div> Searching impression logs...</div>';

        try {
            const res = await fetch(`${API}/api/config/impression-search?agency_id=${agencyId}&days=${days}&min_impressions=${minImpr}`);
            const json = await res.json();
            if (!json.success) { container.innerHTML = `<div class="empty">${json.error}</div>`; return; }
            if (json.count === 0) { container.innerHTML = '<div class="empty">No impressions found matching criteria.</div>'; return; }

            let html = `<div style="margin-bottom:8px;font-size:11px;color:#8b98a5;">
                Found ${json.count} DSP advertisers: <span class="text-green">${json.mapped_count} mapped</span> ¬∑ <span class="text-yellow">${json.unmapped_count} unmapped</span>
            </div>`;
            html += '<table><thead><tr><th>DSP Advertiser</th><th>Platform</th><th class="text-right">Impressions</th><th>Active Days</th><th>Status</th><th></th></tr></thead><tbody>';
            json.data.forEach(r => {
                const isMapped = r.STATUS === 'MAPPED';
                html += `<tr>
                    <td>${esc(r.DSP_ADVERTISER_NAME || 'Unknown')} <span class="text-muted">(${r.DSP_ADVERTISER_ID})</span></td>
                    <td class="text-muted">${esc(r.PLATFORM_NAME || '')} (${r.PLATFORM_TYPE_ID || ''})</td>
                    <td class="text-right text-yellow">${fmt(r.IMPRESSIONS)}</td>
                    <td class="text-muted">${r.ACTIVE_DAYS || '‚Äî'}</td>
                    <td>${isMapped
                        ? `<span class="badge badge-green">Mapped</span> <span class="text-muted" style="font-size:10px">${esc(r.QUORUM_ADVERTISER_NAME || '')}</span>`
                        : '<span class="badge badge-yellow">Unmapped</span>'
                    }</td>
                    <td>${!isMapped ? `<button class="btn btn-sm btn-primary" onclick='openMapModal(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Map</button>` : ''}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        } catch(e) {
            container.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
        }
    }

    // =========================================================================
    // MAP CAMPAIGN MODAL (from discovery)
    // =========================================================================
    function openMapModal(row) {
        _mapData = row;
        document.getElementById('mapDspName').textContent = `${row.DSP_ADVERTISER_NAME || 'Unknown'} (ID: ${row.DSP_ADVERTISER_ID})`;
        document.getElementById('mapPlatform').textContent = `${row.PLATFORM_NAME || ''} (PT: ${row.PLATFORM_TYPE_ID || ''})`;
        document.getElementById('mapImpressions').textContent = fmt(row.IMPRESSIONS);
        document.getElementById('mapAdvSearch').value = '';
        document.getElementById('mapAdvId').value = '';
        document.getElementById('mapAdvSelected').style.display = 'none';
        document.getElementById('mapAdvResults').classList.remove('show');
        openModal('modalMap');
    }

    let _mapSearchTimer = null;
    async function searchAdvForMap() {
        const q = document.getElementById('mapAdvSearch').value.trim();
        const dropdown = document.getElementById('mapAdvResults');
        if (q.length < 2) { dropdown.classList.remove('show'); return; }
        clearTimeout(_mapSearchTimer);
        _mapSearchTimer = setTimeout(async () => {
            try {
                const agencyId = _mapData.AGENCY_ID || currentAgencyId || '';
                const res = await fetch(`${API}/api/config/search-advertisers?q=${encodeURIComponent(q)}&agency_id=${agencyId}`);
                const json = await res.json();
                if (!json.success || json.count === 0) { dropdown.classList.remove('show'); return; }
                dropdown.innerHTML = json.data.map(r => `
                    <div class="ac-item" onclick="selectMapAdv(${r.ADVERTISER_ID}, '${esc(r.ADVERTISER_NAME || '')}')">
                        ${esc(r.ADVERTISER_NAME || '')} <span class="text-muted">(ID: ${r.ADVERTISER_ID})</span>
                    </div>
                `).join('');
                dropdown.classList.add('show');
            } catch(e) { dropdown.classList.remove('show'); }
        }, 300);
    }

    function selectMapAdv(id, name) {
        document.getElementById('mapAdvId').value = id;
        document.getElementById('mapAdvSearch').value = name;
        document.getElementById('mapAdvResults').classList.remove('show');
        document.getElementById('mapAdvSelected').textContent = `‚úì ${name} (ID: ${id})`;
        document.getElementById('mapAdvSelected').style.display = 'block';
    }

    async function submitMapCampaign() {
        const advId = document.getElementById('mapAdvId').value;
        if (!advId) { showToast('Select an advertiser', 'error'); return; }
        try {
            const res = await fetch(API + '/api/config/map-campaign', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    dsp_advertiser_id: _mapData.DSP_ADVERTISER_ID,
                    platform_type: _mapData.PLATFORM_TYPE_ID,
                    quorum_advertiser_id: parseInt(advId),
                    agency_id: _mapData.AGENCY_ID,
                    dsp_advertiser_name: _mapData.DSP_ADVERTISER_NAME
                })
            });
            const json = await res.json();
            closeModal('modalMap');
            if (json.success) {
                showToast('Campaign mapped!');
                searchImpressions();
                if (currentAdvId) refreshDetail();
            } else showToast(json.error, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    // Close autocomplete on outside click
    document.addEventListener('click', e => {
        if (!e.target.closest('.autocomplete-wrap'))
            document.querySelectorAll('.autocomplete-results').forEach(d => d.classList.remove('show'));
    });

    // Close modals on backdrop click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', e => {
            if (e.target === overlay) overlay.classList.remove('active');
        });
    });

    // =========================================================================
    // INIT
    // =========================================================================
    initAuth().then(async () => {
        await loadAgencies();
        loadAdvertiserList();
    }).catch(() => {
        loadAgencies();
        loadAdvertiserList();
    });
    </script>
</body>
</html>
